#!/bin/sh
# $Id$
# This script does the following:
#   - updates jafar copy in pollux:/usr/local/jafar
#   - generate html documentation with doxygen
#   - compile from scratch several modules

MAILTO=jafar-source

output=/tmp/jafar.daily
rm -f $output

(

# compilation host
targetHost=chico

SSH='/usr/local/bin/ssh'

JAFAR_DIR='/usr/local/jafar'

# configure command
configureCmd='./configure --with-opencv=/usr/local/opencv --with-swig=/home/tlemaire/usr/i386-linux/bin'

# modules to be checked
MODULES="kernel helloworld image display jmath hpm cine model3d stereo filter slam facetsmap"

# makefile targets to be executed
TARGETS="clean lib tcl test-build test"

echo '\n--------------------- svn update -----------------------------\n'

echo 'Jafar backbone...'

if ${SSH} ${targetHost} "setenv JAFAR_DIR ${JAFAR_DIR}; svn up ${JAFAR_DIR}" ; then

    for m in ${MODULES}; do
	echo ""
	echo "Module ${m}..."
	if test -d ${JAFAR_DIR}/modules/$m ; then
	    ${SSH} ${targetHost} "setenv JAFAR_DIR ${JAFAR_DIR}; \
		svn up ${JAFAR_DIR}/modules/$m" 
	else
	    echo "svn co svn+ssh://pollux.laas.fr/svn/jafar/jafarModules/trunk/${m} ${JAFAR_DIR}/modules/${m}"
	    ${SSH} ${targetHost} "setenv JAFAR_DIR ${JAFAR_DIR}; \
		svn co svn+ssh://pollux.laas.fr/svn/jafar/jafarModules/trunk/${m} ${JAFAR_DIR}/modules/${m}"
	fi
    done

    echo '\n------------------- Documentation ----------------------------\n'
    # a recent doxygen and dot are installed on warhol
    if ${SSH} warhol "cd ${JAFAR_DIR}; make doc" > /dev/null 2>&1; then
        echo "html...OK"
    else
        echo "html...ERROR"
    fi

    echo '\n---------------------- Configure -----------------------------\n'

    if ${SSH} ${targetHost} "cd ${JAFAR_DIR}; \
	setenv JAFAR_DIR ${JAFAR_DIR}; \
	${configureCmd}" >/dev/null ; then
	
	echo "${configureCmd}...OK"

	echo '\n--------------------- Compilation ----------------------------\n'
	for m in ${MODULES}; do
	    echo "** module ${m}"

	    for t in ${TARGETS}; do
		if ${SSH} ${targetHost} "cd /usr/local/jafar/modules/${m}; \
		    setenv JAFAR_DIR ${JAFAR_DIR}; \
		    make ${t}" > /dev/null 2>&1; then
		    echo "${t}...OK"
		else
		    echo "${t}...ERROR"
		fi

	    done
	    echo '\n'
	done
    else
	echo "${configureCmd}...ERROR"	
    fi
else
    echo 'ERROR: svn update failed'
fi
echo '\n------------------------ End ---------------------------------\n'
) > $output 2>&1
mailx -s 'Daily Jafar report' $MAILTO < $output
rm -f $output
exit 0

