#!/bin/sh
# $Id$
# This script does the following:
#   - backup jafar subversion repository to /usr/local/jafar/svn-backup
#   - updates jafar copy in /usr/local/jafar
#   - generate html documentation with doxygen
#   - compile from scratch several modules

MAILTO=jafar-source@laas.fr
#MAILTO=tlemaire@laas.fr

output=/tmp/jafar.daily
rm -f $output

# log of all operations
logDir=/usr/local/jafar/log/
rm -f ${logDir}/*.log

(
umask 02

SSH='/usr/bin/ssh'

JAFAR_DIR='/usr/local/jafar'

DOT_BINDIR='/usr/local/graphviz/bin'
PATH=${PATH}:${DOT_BINDIR};

# configure command
configureCmd='env CFLAGS=-fno-strict-aliasing CXXFLAGS=-fno-strict-aliasing ./configure --with-opencv=/usr/local/opencv --with-swig=/home/tlemaire/usr/i386-linux/bin --with-lapack --with-boost_sandbox=/home/tlemaire/usr/local/boost-sandbox'

# modules to be checked
#MODULES="kernel helloworld jmath"
MODULES="kernel helloworld jmath image display geom hpm gfm model3d stereo vme filter slam facetsmap camera omnivis locpano sas"

# makefile targets to be executed
TARGETS="clean lib tcl test-build test"

echo '\n--------------------- svn backup -----------------------------\n'

if ${SSH} svn.laas.fr "setenv LD_LIBRARY_PATH /usr/local/lib ; ${JAFAR_DIR}/bin/hot-backup.py /svn/jafar /usr/local/jafar/svn-backup" ; then
    echo "repository backup...OK"
else
    echo "repository backup...ERROR"
fi

echo '\n--------------------- svn update -----------------------------\n'

echo 'Jafar backbone...'
svn up ${JAFAR_DIR}

for m in ${MODULES}; do
    echo ""
    echo "Module ${m}..."
    if test -d ${JAFAR_DIR}/modules/$m ; then
	svn up ${JAFAR_DIR}/modules/$m
    else
	echo "svn co svn+ssh://svn.laas.fr/svn/jafar/jafarModules/trunk/${m} ${JAFAR_DIR}/modules/${m}"
	svn co svn+ssh://svn.laas.fr/svn/jafar/jafarModules/trunk/${m} ${JAFAR_DIR}/modules/${m}
    fi
done

cd ${JAFAR_DIR}

echo '\n---------------------- Configure -----------------------------\n'

if ${configureCmd} > ${logDir}/configure.log 2>&1; then
    echo "${configureCmd}...OK"

    echo '\n------------------- Documentation ----------------------------\n'
    
    if make doc > ${logDir}/doc.log 2>&1 ; then
	echo "html...OK"
    else
	echo "html...ERROR"
    fi

    echo '\n--------------------- Compilation ----------------------------\n'
    for m in ${MODULES}; do
	echo "** module ${m}"
	cd ${JAFAR_DIR}/modules/${m}
	for t in ${TARGETS}; do
	    if make ${t} > ${logDir}/${m}.${t}.log 2>&1; then
		echo "${t}...OK"
	    else
		echo "${t}...ERROR"
	    fi
	done
	echo '\n'
    done
else
    echo "${configureCmd}...ERROR"	
fi
echo '\n------------------------ End ---------------------------------\n'
) > $output 2>&1
mailx -s 'Daily Jafar report' $MAILTO < $output
rm -f $output
exit 0
