#! /bin/sh
#set -e

SCRIPT_PATH=$(cd ${0%/*} && echo $PWD/${0##*/})
MY_JAFAR_DIR=`dirname "$SCRIPT_PATH"`/..
LISTOFFILES=""

. ${MY_JAFAR_DIR}/bin/git_config.sh

usage()
{
    cat <<EOF
	add_module [name]

    imports the jafar module 'name' 

The script adds C, C++, documentation, Swig and scripts 
You have to add any other files (if any) manually
EOF
    exit 1
}

getExistingFilesOnly()
{
	FINALLIST=""
	for i in $(ls -d $LISTOFFILES 2> /dev/null); do
		# Adding files or directories
		if [ -e $i ]; then 
			FINALLIST="$FINALLIST $i"
		fi
	done
	echo $FINALLIST
}

MODULE=`echo $1 | sed 's,/$,,'`
test -z "$MODULE" && usage;

if ! test -d "$MODULE"; then
    echo "ERROR: $MODULE is not a directory"
    exit 1
fi

# Check if a module of same kind exists
# Otherwise, create the repository
# For this, call create_jafar_git.sh, with $1 = $MODULE

sed "s,\${1},$MODULE,"  ${MY_JAFAR_DIR}/bin/create_jafar_git.sh | ssh ${VCS_USER}@${HOST} "sh -s"

if [ $? -ne 0 ]
then
	exit 1
fi

TOPDIR=$PWD/$MODULE

cd $TOPDIR
git init 

LISTOFFILES="CMakeLists.txt COPYRIGHT README doc include macro src test_suite .gitignore"
git add $(getExistingFilesOnly)

cd $TOPDIR/doc
LISTOFFILES="*.doxy *.tcl *.hpp *.cpp"
git add $(getExistingFilesOnly)

cd $TOPDIR/include
LISTOFFILES="*.i"
git add $(getExistingFilesOnly)

cd $TOPDIR/include/$MODULE
LISTOFFILES="*.hpp *.h *.i"
git add $(getExistingFilesOnly)

cd $TOPDIR/macro
LISTOFFILES="*.tcl *.rb"
git add $(getExistingFilesOnly)

cd $TOPDIR/src
LISTOFFILES="*.cpp *.c ruby"
git add $(getExistingFilesOnly)

cd $TOPDIR/src/ruby
LISTOFFILES="extconf.rb"
git add $(getExistingFilesOnly)

cd $TOPDIR/test_suite
LISTOFFILES="*.cpp *.hpp"
git add $(getExistingFilesOnly)

cd $TOPDIR

git commit -m "Initial commit of ${MODULE}"

git push ${BASE_URL}/modules/${MODULE} master

echo "[remote \"origin\"]
	url = ${BASE_URL}/modules/${MODULE}
	fetch = +refs/heads/*:refs/remotes/origin/*
[branch \"master\"]
	remote = origin
	merge = refs/heads/master" >> ${TOPDIR}/.git/config
